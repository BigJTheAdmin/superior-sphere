const w=(a,f="")=>{const d=document.getElementById("debug");d&&(d.textContent+=(f?f+`:
`:"")+(typeof a=="string"?a:JSON.stringify(a,null,2))+`

`)},O=()=>{const a=document.getElementById("debugBox");a&&!a.open&&(a.open=!0)};window.addEventListener("load",()=>{const a=L.map("map").setView([20,0],2);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:18,attribution:"&copy; OpenStreetMap"}).addTo(a);const f=L.layerGroup().addTo(a),d=document.getElementById("status"),T=document.getElementById("debug"),k=document.getElementById("runBtn"),I=document.getElementById("clearBtn"),v=document.getElementById("target"),S=document.getElementById("addOrigin"),x=document.getElementById("hopList");k.addEventListener("click",A),I.addEventListener("click",()=>{f.clearLayers(),T.textContent="",x.innerHTML="",d.textContent="Cleared.",a.setView([20,0],2)});async function A(){T.textContent="",x.innerHTML="";const y=v.value.trim();if(!y){alert("Enter a target");return}d.textContent="Running local traceroute‚Ä¶",f.clearLayers();let m="";if(S.checked)try{const r=await fetch("https://api.ipify.org?format=json").then(o=>o.ok?o.json():null);r?.ip&&(m=r.ip)}catch{}try{const r=await fetch("/api/local-traceroute.json",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({target:y,originIp:m})}),o=await r.text();if(w(o,"server response"),!r.ok)throw new Error(`HTTP ${r.status} ${o}`);const i=JSON.parse(o);(!Array.isArray(i.hops)||i.hops.length===0)&&(d.textContent="No hops parsed. See Debug for raw traceroute output & command used.",O()),H(i)}catch(r){w(String(r),"error"),O(),d.textContent="Traceroute failed (see Debug).",alert("Traceroute failed. See Debug.")}}function H(y){const m=Array.isArray(y.hops)?y.hops:[],r=y.origin||null,o=[];r&&typeof r.lat=="number"&&typeof r.lon=="number"&&o.push({type:"origin",lat:r.lat,lon:r.lon,ip:r.ip||null,approx:!1,label:"Origin"});for(const t of m)o.push({type:"hop",ip:t?.ip??null,rtt:t?.rtt??null,lat:typeof t?.lat=="number"?t.lat:null,lon:typeof t?.lon=="number"?t.lon:null,approx:!1,city:t?.city,country:t?.country});const i=[];o.forEach((t,l)=>{typeof t.lat=="number"&&typeof t.lon=="number"&&i.push(l)});const B=(t,l,e)=>t+(l-t)*e;if(i.length){for(let e=0;e<i.length-1;e++){const n=i[e],p=i[e+1],c=o[n],h=o[p],E=p-n;for(let s=n+1;s<p;s++){const u=o[s];if(u.lat==null||u.lon==null){const C=(s-n)/E;u.lat=B(c.lat,h.lat,C),u.lon=B(c.lon,h.lon,C),u.approx=!0}}}const t=i[0];for(let e=0;e<t;e++){const n=o[e];if(n.lat==null||n.lon==null){const p=o[t],c=(t-e)/(t+1);n.lat=p.lat+.05*c,n.lon=p.lon-.05*c,n.approx=!0}}const l=i[i.length-1];for(let e=l+1;e<o.length;e++){const n=o[e];if(n.lat==null||n.lon==null){const p=o[l],c=e-l;n.lat=p.lat+.05*c,n.lon=p.lon+.05*c,n.approx=!0}}}else{let t=0,l=0;o.length&&o[0].type==="origin"&&(t=o[0].lat,l=o[0].lon),o.forEach((e,n)=>{(e.lat==null||e.lon==null)&&(e.lat=t+.03*n,e.lon=l+.03*n,e.approx=!0)})}f.clearLayers(),x.innerHTML="";let g=null;const b=[];let $=0;if(o.forEach(t=>{const l=[t.lat,t.lon],e=t.type==="hop",n=t.approx?"#888888":"#00ffff",p=t.approx||g&&g.approx?"#9aa4aa":"#00ffff",c=t.approx||g&&g.approx?"6,6":null;let h;if(e){$++;const u=t.ip||"*";h=`${$}: ${u}${t.approx?" (approx)":""}`}else h="üè† Origin";const E=L.circleMarker(l,{radius:e?6:7,color:n,weight:2,fillColor:n,fillOpacity:t.approx?.35:.9}).addTo(f),s=[];if(e?(s.push(`<b>Hop ${$}${t.approx?" (approx)":""}</b>`),t.ip&&s.push(t.ip),typeof t.rtt=="number"&&s.push(`${t.rtt} ms`),(t.city||t.country)&&s.push(`${t.city?t.city+", ":""}${t.country||""}`)):(s.push("<b>Origin</b>"),t.ip&&s.push(t.ip)),E.bindPopup(s.join("<br>")),E.bindTooltip(h,{permanent:!0,direction:"right",offset:[10,0],className:"hop-label"}).openTooltip(),g&&L.polyline([[g.lat,g.lon],l],{color:p,weight:3,opacity:.8,dashArray:c}).addTo(f),g=t,b.push(l),e){const u=document.createElement("li");u.innerHTML=`<code>${t.ip||"*"}${t.approx?" (approx)":""}</code> ${typeof t.rtt=="number"?`‚Äî ${t.rtt} ms`:""} ${t.city||t.country?`<span class="muted">(${t.city?t.city+", ":""}${t.country||""})</span>`:""}`,x.appendChild(u)}}),b.length){new Set(b.map(e=>e.join(","))).size>=2?a.fitBounds(b,{padding:[30,30]}):a.setView(b[0],7);const l=m.length;d.textContent=`Done. Plotted ${l} hop${l===1?"":"s"}.`}else d.textContent="No hops to plot.";const j={used:y.used,rawPreview:y.rawPreview?.slice(0,800)||""};w(j,"diagnostics")}});
