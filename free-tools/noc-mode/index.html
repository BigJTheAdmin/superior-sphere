<!DOCTYPE html><html class="scroll-smooth" lang="en-US" data-astro-cid-5hce7sga> <head><!-- Keep charset FIRST to prevent mojibake like â€™ --><meta charset="utf-8"><!-- Mobile default at ~75% scale (no pinch-zoom needed) --><meta name="viewport" content="width=device-width, initial-scale=0.75, viewport-fit=cover"><!-- Helpful mobile/browser theming --><meta name="theme-color" content="#0b0f14"><meta name="color-scheme" content="dark light"><meta name="format-detection" content="telephone=no"><!-- Your existing head (title, SEO, OG tags, etc.) --><!-- BaseHead --><title>NOC Mode Dashboard</title><meta name="description" content="Networking tools, automation, and troubleshooting for IT professionals."><link rel="canonical" href="https://pingtracessh.com/free-tools/noc-mode/"><!-- Favicons (match files in /public) --><link rel="icon" href="/icon.png?v=2" sizes="any"><link rel="icon" href="/PTSicon.png?v=2" type="image/png"><link rel="apple-touch-icon" href="/icon.png?v=2"><meta name="theme-color" content="#0f0f0f"><!-- Open Graph --><meta property="og:type" content="website"><meta property="og:title" content="NOC Mode Dashboard"><meta property="og:description" content="Networking tools, automation, and troubleshooting for IT professionals."><meta property="og:url" content="https://pingtracessh.com/free-tools/noc-mode/"><meta property="og:site_name" content="Ping.Trace.SSH"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://pingtracessh.com/"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="630"><!-- Twitter --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="NOC Mode Dashboard"><meta name="twitter:description" content="Networking tools, automation, and troubleshooting for IT professionals."><meta name="twitter:image" content="https://pingtracessh.com/"><!-- Optional: sitemap/rss if you actually generate them --><link rel="sitemap" type="application/xml" href="/sitemap-index.xml"><link rel="alternate" type="application/rss+xml" title="Blog" href="/rss.xml"><!-- Mobile-safe baseline that won’t fight Tailwind --><link rel="stylesheet" href="/_astro/_slug_.BJY2hdSo.css">
<link rel="stylesheet" href="/_astro/noc-mode.BidcVy12.css"><script type="module" src="/_astro/page.V2R8AmkL.js"></script></head> <body class="bg-global-bg text-global-text flex min-h-screen flex-col px-4 pt-6 font-mono text-sm font-normal antialiased sm:px-8" data-astro-cid-5hce7sga> <script>
	const lightModePref = window.matchMedia("(prefers-color-scheme: light)");

	function getUserPref() {
		const storedTheme = typeof localStorage !== "undefined" && localStorage.getItem("theme");
		return storedTheme || (lightModePref.matches ? "light" : "dark");
	}

	function setTheme(newTheme) {
		if (newTheme !== "light" && newTheme !== "dark") {
			return console.warn(
				`Invalid theme value '${newTheme}' received. Expected 'light' or 'dark'.`,
			);
		}

		const root = document.documentElement;

		// root already set to newTheme, exit early
		if (newTheme === root.getAttribute("data-theme")) {
			return;
		}

		root.setAttribute("data-theme", newTheme);

		if (typeof localStorage !== "undefined") {
			localStorage.setItem("theme", newTheme);
		}
	}

	// initial setup
	setTheme(getUserPref());

	// View Transitions hook to restore theme
	document.addEventListener("astro:after-swap", () => setTheme(getUserPref()));

	// listen for theme-change custom event, fired in src/components/ThemeToggle.astro
	document.addEventListener("theme-change", (e) => {
		setTheme(e.detail.theme);
	});

	// listen for prefers-color-scheme change.
	lightModePref.addEventListener("change", (e) => setTheme(e.matches ? "light" : "dark"));
</script> <a class="sr-only focus:not-sr-only focus:fixed focus:start-1 focus:top-1.5" href="#main">skip to content
</a> <header class="group relative mb-8 flex w-full items-center sm:ps-18" id="main-header"> <!-- Left: Logo + Nav --> <div class="sm:flex-column flex flex-col items-center sm:items-center"> <a aria-current="false" class="inline-flex items-center sm:relative sm:inline-block" href="/"> <img src="/PTSwTerminalHORIZONTAL.png" alt="PingTraceSSH Logo" class="me-3 h-24 w-auto sm:h-45" loading="eager" decoding="async"> </a> <nav aria-label="Main menu" class="bg-global-bg/85 text-accent absolute -inset-x-4 top-14 hidden flex-col items-end gap-y-4 rounded-md py-4 shadow backdrop-blur-sm group-[.menu-open]:z-50 group-[.menu-open]:flex sm:static sm:z-auto sm:-ms-4 sm:mt-1 sm:flex sm:flex-row sm:items-center sm:divide-x sm:rounded-none sm:bg-transparent sm:py-0 sm:shadow-none sm:backdrop-blur-none" id="navigation-menu"> <a aria-current="false" class="px-4 py-4 underline-offset-2 hover:underline sm:py-0" data-astro-prefetch href="/"> Home </a><a aria-current="false" class="px-4 py-4 underline-offset-2 hover:underline sm:py-0" data-astro-prefetch href="/services/"> Services </a><a aria-current="false" class="px-4 py-4 underline-offset-2 hover:underline sm:py-0" data-astro-prefetch href="/career/"> Career Tools </a><a aria-current="false" class="px-4 py-4 underline-offset-2 hover:underline sm:py-0" data-astro-prefetch href="/free-tools/"> Networking Tools </a><a aria-current="false" class="px-4 py-4 underline-offset-2 hover:underline sm:py-0" data-astro-prefetch href="/breakroom/"> Breakroom </a><a aria-current="false" class="px-4 py-4 underline-offset-2 hover:underline sm:py-0" data-astro-prefetch href="/about/"> About </a> </nav> </div> <!-- Right: Search + Donate (pushed fully right) --> <div class="ms-auto flex items-center gap-4 shrink-0"> <a href="https://buy.stripe.com/fZu8wQ3MMaeH60O5R79k40f" class="inline-flex items-center" aria-label="Donate"> <img src="/donate2.png" alt="Donate" class="h-50 w-auto cursor-pointer transition-transform hover:scale-125" loading="lazy" decoding="async"> </a> <site-search class="ms-auto" id="search"> <button class="hover:text-accent flex h-9 w-9 cursor-pointer items-center justify-center rounded-md" aria-keyshortcuts="Control+K Meta+K" data-open-modal disabled> <!-- Magnifying glass --> <svg aria-hidden="true" class="h-7 w-7" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"> <path d="M0 0h24v24H0z" stroke="none"></path> <circle cx="11" cy="11" r="7"></circle> <path d="M21 21l-6-6"></path> </svg> <span class="sr-only">Open Search</span> </button> <dialog aria-label="search" class="bg-global-bg h-full max-h-full w-full max-w-full border border-zinc-400 shadow-sm backdrop:backdrop-blur-sm open:flex sm:mx-auto sm:mt-16 sm:mb-auto sm:h-max sm:max-h-[calc(100%-8rem)] sm:min-h-[15rem] sm:w-5/6 sm:max-w-[48rem] sm:rounded-md"> <div class="dialog-frame flex grow flex-col gap-4 p-6 pt-12 sm:pt-6"> <button class="ms-auto cursor-pointer rounded-md bg-zinc-200 p-2 font-semibold dark:bg-zinc-700" data-close-modal>Close</button> <!-- SEARCH INPUT + RESULTS (replaces pagefind UI) --> <div class="flex flex-col gap-3"> <div class="relative"> <span class="pointer-events-none absolute left-3 top-1/2 -translate-y-1/2 opacity-70"> <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"> <circle cx="11" cy="11" r="7"></circle> <line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </span> <input id="pts-search-input" type="search" placeholder="Search pages…" class="w-full rounded-md border border-zinc-400 bg-transparent py-2 pl-9 pr-9 outline-none focus:border-accent" autocomplete="off" aria-controls="pts-search-results"> <button id="pts-search-clear" class="absolute right-2 top-1/2 -translate-y-1/2 rounded p-1 opacity-70 hover:opacity-100" title="Clear" aria-label="Clear" hidden> <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"> <line x1="18" y1="6" x2="6" y2="18"></line> <line x1="6" y1="6" x2="18" y2="18"></line> </svg> </button> </div> <div id="pts-search-results" role="listbox" class="max-h-[50vh] overflow-auto rounded-md border border-zinc-400"> <!-- results render here --> </div> </div> </div> </dialog> </site-search> <script type="module">class p extends HTMLElement{#n;#e;#r;#o;#t;#s=[];#l=!1;constructor(){super(),this.#o=this.querySelector("button[data-open-modal]"),this.#n=this.querySelector("button[data-close-modal]"),this.#e=this.querySelector("dialog"),this.#r=this.querySelector(".dialog-frame"),this.#t=new AbortController,this.#o?(this.#o.addEventListener("click",this.openModal),this.#o.disabled=!1):console.warn("Search button not found"),this.#n?this.#n.addEventListener("click",this.closeModal):console.warn("Close button not found"),this.#e?this.#e.addEventListener("close",()=>{window.removeEventListener("click",this.onWindowClick)}):console.warn("Dialog not found")}connectedCallback(){window.addEventListener("keydown",this.onWindowKeydown,{signal:this.#t.signal}),(window.requestIdleCallback||(t=>setTimeout(t,1)))(()=>this.#a())}disconnectedCallback(){this.#t.abort()}openModal=e=>{if(!this.#e)return;this.#e.showModal(),this.querySelector("#pts-search-input")?.focus(),e?.stopPropagation(),window.addEventListener("click",this.onWindowClick,{signal:this.#t.signal}),this.#i(this.#s.slice(0,10))};closeModal=()=>this.#e?.close();onWindowClick=e=>{("href"in(e.target||{})||document.body.contains(e.target)&&!this.#r?.contains(e.target))&&this.closeModal()};onWindowKeydown=e=>{this.#e&&(e.metaKey===!0||e.ctrlKey===!0)&&e.key==="k"&&(this.#e.open?this.closeModal():this.openModal(),e.preventDefault())};async#a(){if(!this.#l)try{const e=await fetch("/api/pages-search.json",{cache:"force-cache"});if(!e.ok)throw new Error("Failed to fetch page index");this.#s=await e.json()}catch(e){console.error(e),this.#s=[]}finally{this.#l=!0,this.#c()}}#c(){const e=this.querySelector("#pts-search-input"),t=this.querySelector("#pts-search-clear");if(!e)return;const i=()=>{const r=e.value.trim().toLowerCase();if(!r){this.#i(this.#s.slice(0,10)),t&&(t.hidden=!0);return}t&&(t.hidden=!1);const l=r.split(/\s+/).filter(Boolean),a=s=>{let o=0;const d=(s.title||"").toLowerCase(),h=(s.description||"").toLowerCase(),u=(s.keywords||[]).map(n=>(n||"").toLowerCase());for(const n of l)d.includes(n)&&(o+=3),u.some(f=>f.includes(n))&&(o+=2),h.includes(n)&&(o+=1);return o},c=this.#s.map(s=>({doc:s,s:a(s)})).filter(s=>s.s>0).sort((s,o)=>o.s-s.s).slice(0,50).map(s=>s.doc);this.#i(c)};e.addEventListener("input",i,{signal:this.#t.signal}),e.addEventListener("keydown",r=>{r.key==="Escape"&&(e.value="",t&&(t.hidden=!0),this.#i(this.#s.slice(0,10)))},{signal:this.#t.signal}),t?.addEventListener("click",()=>{e.value="",t.hidden=!0,this.#i(this.#s.slice(0,10)),e.focus()},{signal:this.#t.signal})}#i(e){const t=this.querySelector("#pts-search-results");if(t){if(!e.length){t.innerHTML='<div class="p-3 text-sm opacity-70">No matches. Try different keywords.</div>';return}t.innerHTML=e.map(i=>`
        <a href="${i.url}" role="option" class="block border-b border-zinc-700/40 p-3 hover:bg-accent/10 focus:bg-accent/10 focus:outline-none">
          <div class="font-semibold">${i.title}</div>
          ${i.description?`<div class="mt-0.5 text-sm opacity-80">${i.description}</div>`:""}
        </a>
      `).join("")}}}customElements.define("site-search",p);</script> </div> <!-- Mobile hamburger --> <mobile-button> <button aria-expanded="false" aria-haspopup="menu" class="group relative ms-4 h-7 w-7 sm:invisible sm:hidden" id="toggle-navigation-menu" type="button"> <span class="sr-only">Open main menu</span> <svg aria-hidden="true" class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 transition-all group-aria-expanded:scale-0 group-aria-expanded:opacity-0" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"> <path d="M3.75 9h16.5m-16.5 6.75h16.5" stroke-linecap="round" stroke-linejoin="round"></path> </svg> <svg aria-hidden="true" class="text-accent absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 scale-0 opacity-0 transition-all group-aria-expanded:scale-100 group-aria-expanded:opacity-100" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"> <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"></path> </svg> </button> </mobile-button> </header> <script type="module">function s(t,e){t.classList.toggle(e)}class l extends HTMLElement{#e=!1;connectedCallback(){const e=document.getElementById("main-header"),n=this.querySelector("button");n?.addEventListener("click",()=>{e&&s(e,"menu-open"),this.#e=!this.#e,n.setAttribute("aria-expanded",this.#e.toString())})}}customElements.define("mobile-button",l);</script> <!-- Live status bar --> <div id="status-ticker-host"></div> <script type="module">
  const host = document.getElementById("status-ticker-host");
  const root = host.attachShadow({ mode: "open" });

  root.innerHTML = `
    <style>
      .ticker-wrapper{overflow:hidden;background:#111;border-bottom:2px solid #333}
      .ticker{display:inline-flex;white-space:nowrap;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:.85rem;padding:.5rem 1rem;gap:3rem;font-weight:700;will-change:transform}
      .lane{display:inline-flex;white-space:nowrap;gap:2rem}
      .chip{display:inline-flex;align-items:center;gap:.5rem;padding:.15rem .5rem;border-radius:9999px;border:1px solid #333;background:#0b0b0b}
      .dot{width:8px;height:8px;border-radius:9999px;box-shadow:0 0 8px currentColor}
      .up{color:#14f195!important}
      .down{color:#ff3b3b!important}
      .checking{color:#ffb020!important}
      .track{position:relative;width:100%;overflow:hidden}
      .rail{display:inline-flex;white-space:nowrap;gap:3rem;animation:scroll linear infinite}
      @keyframes scroll{from{transform:translateX(0)}to{transform:translateX(-50%)}}
      .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0;white-space:nowrap}
    </style>

    <div class="ticker-wrapper" aria-live="polite" aria-atomic="false">
      <div class="track">
        <div id="rail" class="rail">
          <div id="laneA" class="ticker lane">Loading…</div>
          <div id="laneB" class="ticker lane">Loading…</div>
        </div>
      </div>
      <span id="a11y" class="sr-only"></span>
    </div>
  `;

  const $ = (s)=>root.querySelector(s);
  const laneA = $("#laneA");
  const laneB = $("#laneB");
  const rail  = $("#rail");
  const a11y  = $("#a11y");

  /** CONFIG **/
  // IMPORTANT: On GitHub Pages, files in /public build to the site root.
  // We compute the correct absolute URL whether you're on a custom domain
  // or a subpath (e.g., https://username.github.io/repo/).
  const JSON_FILENAME = "ping-services.json";
  let FETCH_URL = "/ping-services.json";
  try {
    const baseHref = document.querySelector('base')?.getAttribute('href') || "/";
    // new URL(relative, base) handles both "/" and "/repo/" styles
    FETCH_URL = new URL(JSON_FILENAME, new URL(baseHref, location.origin)).toString();
  } catch { /* noop; fallback stays "/ping-services.json" */ }

  const BASE_POLL_MS = 30_000;
  const POLL_JITTER_MS = 5_000;
  const FETCH_TIMEOUT_MS = 12_000;           // backend sometimes slow
  const PX_PER_SEC = 90;
  const DATA_STALE_MS = 3 * 60_000;          // too old to trust
  const DATA_FRESH_MS = 75_000;              // fresh enough to infer UP if no fails
  const REQUIRE_CONSEC_FAILS = 2;            // confirm DOWN
  const LOCAL_CACHE_KEY = "pts_status_ticker_cache_v4";
  const STATE_CACHE_KEY = "pts_status_ticker_state_v4";

  const renderCache = loadJson(LOCAL_CACHE_KEY) || { items: [], ts: 0 };
  const stateCache  = loadJson(STATE_CACHE_KEY)  || {}; // { [name]: {state,lastTs} }

  // Instant paint from cache (prevents empty bar on first load)
  if (renderCache.items?.length) {
    render(renderCache.items); autosizeScroller();
  }

  // Poll with jitter
  let pollTimer=null;
  const tick = async()=>{ await update(); scheduleNext(); };
  scheduleNext(true);
  function scheduleNext(immediate=false){
    if(pollTimer) clearTimeout(pollTimer);
    if(immediate) return void tick();
    const j=(Math.random()*2-1)*POLL_JITTER_MS;
    pollTimer=setTimeout(tick, BASE_POLL_MS+j);
  }

  document.addEventListener("visibilitychange", ()=> {
    rail.style.animationPlayState = document.hidden ? "paused" : "running";
  });
  new ResizeObserver(()=>autosizeScroller()).observe(rail);

  /** fetch with timeout + one retry */
  async function fetchJson() {
    const once = async () => {
      const controller = new AbortController();
      const timer = setTimeout(()=>controller.abort(), FETCH_TIMEOUT_MS);
      try {
        const res = await fetch(FETCH_URL, { cache: "no-store", signal: controller.signal });
        if (!res.ok) throw new Error(`HTTP ${res.status} at ${FETCH_URL}`);
        return await res.json();
      } finally { clearTimeout(timer); }
    };
    try { return await once(); }
    catch(e){
      console.warn("[StatusTicker] fetch failed, retrying:", e?.message||e);
      try { return await once(); }
      catch(e2){
        console.warn("[StatusTicker] second fetch failed, using cache:", e2?.message||e2);
        // fall back to last known good data if we have it
        if (renderCache.items?.length) return renderCache.items;
        throw e2;
      }
    }
  }

  async function update(){
    let data;
    try { data = await fetchJson(); }
    catch { return; } // keep last good

    const arr = Array.isArray(data) ? data : (data?.results ?? data ?? []);
    if (!Array.isArray(arr) || !arr.length) return;

    const cooked = postProcess(arr);
    if (!cooked.length) return;

    render(cooked); autosizeScroller();
    saveJson(LOCAL_CACHE_KEY, { items: cooked, ts: Date.now() });

    const downs=cooked.filter(i=>i.state==="down");
    a11y.textContent = downs.length ? `${downs.length} services down: ${downs.map(d=>d.name).join(", ")}`
                                    : `All services up (${cooked.length})`;
  }

  function postProcess(raw){
    const now=Date.now();
    const list = raw.map(r=>normalizeOne(r,now)).filter(Boolean).filter(i=>!i.isStale).map(applyOptimistic);

    // persist last known
    for(const i of list){ stateCache[i.name]={state:i.state,lastTs:i.lastTs}; }
    saveJson(STATE_CACHE_KEY,stateCache);

    // down -> up -> checking
    const order={down:0,up:1,checking:2};
    list.sort((a,b)=> order[a.state]-order[b.state] || a.name.localeCompare(b.name));
    return list;
  }

  function normalizeOne(r, now){
    const name=String(r.name ?? r.service ?? r.id ?? "").trim();
    if(!name) return null;

    const lastTs = toMs(r.lastSeen) ?? toMs(r.lastUpdate) ?? toMs(r.checkedAt) ?? toMs(r.timestamp) ?? now;
    const age = now - lastTs;
    const isStale = age > DATA_STALE_MS;
    const isFresh = age <= DATA_FRESH_MS;

    const explicitUp   = asBool(r.up) || asBool(r.ok) || r.status===200 || String(r.status||"").startsWith("2");
    const explicitDown = asBool(r.down) || String(r.state||"").toLowerCase()==="down" ||
                         String(r.health||"").toLowerCase()==="unhealthy" || String(r.status||"").startsWith("5");

    const fails = Number(r.consecutiveFails ?? r.failures ?? r.consecutive_failures ?? 0) || 0;

    return {
      name, lastTs, isStale, isFresh, explicitUp, explicitDown, fails,
      latencyMs: numOrNull(r.latencyMs ?? r.rtt ?? r.latency),
      region: r.region ?? r.pop ?? null,
      state: explicitUp ? "up" : (explicitDown ? "down" : "checking"),
    };
  }

  // **Key inference**
  // - Explicit UP => UP
  // - Explicit DOWN (fresh) => DOWN if fails >= threshold (or counter missing)
  // - Otherwise:
  //     if sample is FRESH and fails==0 => infer UP (prevents “stuck CHECKING”)
  //     else keep last known UP if not stale
  //     else CHECKING
  function applyOptimistic(i){
    const cached = stateCache[i.name];

    if(i.explicitUp){ i.state="up"; return i; }
    if(i.explicitDown && !i.isStale){
      if(i.fails>=REQUIRE_CONSEC_FAILS || i.fails===0){ i.state="down"; return i; }
      i.state="checking"; return i;
    }
    if(i.isFresh && i.fails===0){ i.state="up"; return i; }

    if(cached){
      const recent = (Date.now()-(cached.lastTs||0)) <= DATA_STALE_MS;
      if(recent && cached.state==="up"){ i.state="up"; return i; }
      if(recent && cached.state==="down"){ i.state="down"; return i; }
    }
    i.state="checking"; return i;
  }

  function render(items){
    const row = items.map(chip).join("");
    laneA.innerHTML=row; laneB.innerHTML=row;
  }

  function chip(i){
    const cls=i.state;
    const label= i.state==="up"?"UP":(i.state==="down"?"DOWN":"CHECKING");
    const title=[`${i.name} — ${label}`,
      i.latencyMs!=null?`Latency: ${Math.round(i.latencyMs)} ms`:null,
      i.region?`Region: ${i.region}`:null,
      i.lastTs?`Updated: ${new Date(i.lastTs).toLocaleString()}`:null
    ].filter(Boolean).join(" • ");
    return `<span class="chip ${cls}" title="${escapeHtml(title)}"><span class="dot ${cls}" aria-hidden="true"></span><span class="label">${escapeHtml(i.name)}: ${label}</span></span>`;
  }

  function autosizeScroller(){
    const wrapW = root.host.getBoundingClientRect().width || 1;
    ensureWidth(laneA,wrapW); ensureWidth(laneB,wrapW);
    const laneW = laneA.scrollWidth || 600;
    const dur = Math.max(8, Math.round(laneW / PX_PER_SEC));
    rail.style.animationDuration = `${dur}s`;
  }
  function ensureWidth(lane,wrapW){
    const minW=Math.max(wrapW,600); let guard=0;
    while(lane.scrollWidth<minW && guard<8){ lane.innerHTML += lane.innerHTML; guard++; }
  }

  // utils
  function asBool(v){ if(typeof v==="boolean")return v; if(typeof v==="number")return v>0; if(typeof v==="string")return ["ok","up","true","healthy","success"].includes(v.toLowerCase()); return false; }
  function toMs(v){ if(v==null) return null; if(typeof v==="number") return v>1e12?v:v*1000; const d=new Date(v); return isNaN(d)?null:d.getTime(); }
  function numOrNull(v){ const n=Number(v); return Number.isFinite(n)?n:null; }
  function escapeHtml(s){ return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;"); }
  function loadJson(k){ try{ return JSON.parse(localStorage.getItem(k)||"null"); }catch{ return null; } }
  function saveJson(k,o){ try{ localStorage.setItem(k, JSON.stringify(o)); }catch{} }
</script> <!-- Main site content --> <main id="main" class="flex-1" data-astro-cid-5hce7sga>  <section class="tool-wrapper" data-astro-cid-6bhvxozq> <h1 data-astro-cid-6bhvxozq>NOC Mode</h1> <p data-astro-cid-6bhvxozq>
Live diagnostics from the browser, external APIs, and (with your consent) rich LAN checks.
      Some tests may be limited by browser/HTTPS policy.
</p> <div class="tool-card" data-astro-cid-6bhvxozq> <!-- Gauges --> <div class="gauges" data-astro-cid-6bhvxozq> <div class="gauge-item" data-astro-cid-6bhvxozq> <svg viewBox="0 0 36 36" class="circular-chart green" data-astro-cid-6bhvxozq> <path class="circle-bg" d="M18 2.0845a 15.9155 15.9155 0 0 1 0 31.831a 15.9155 15.9155 0 0 1 0 -31.831" data-astro-cid-6bhvxozq></path> <path id="latency-gauge" class="circle" stroke-dasharray="0, 100" d="M18 2.0845a 15.9155 15.9155 0 0 1 0 31.831a 15.9155 15.9155 0 0 1 0 -31.831" data-astro-cid-6bhvxozq></path> <text x="18" y="20.35" class="percentage" id="latency" data-astro-cid-6bhvxozq>--</text> </svg> <p data-astro-cid-6bhvxozq>Latency (ms)</p> </div> <div class="gauge-item" data-astro-cid-6bhvxozq> <svg viewBox="0 0 36 36" class="circular-chart purple" data-astro-cid-6bhvxozq> <path class="circle-bg" d="M18 2.0845a 15.9155 15.9155 0 0 1 0 31.831a 15.9155 15.9155 0 0 1 0 -31.831" data-astro-cid-6bhvxozq></path> <path id="jitter-gauge" class="circle" stroke-dasharray="0, 100" d="M18 2.0845a 15.9155 15.9155 0 0 1 0 31.831a 15.9155 15.9155 0 0 1 0 -31.831" data-astro-cid-6bhvxozq></path> <text x="18" y="20.35" class="percentage" id="jitter" data-astro-cid-6bhvxozq>--</text> </svg> <p data-astro-cid-6bhvxozq>Jitter (ms)</p> </div> <div class="gauge-item" data-astro-cid-6bhvxozq> <svg viewBox="0 0 36 36" class="circular-chart blue" data-astro-cid-6bhvxozq> <path class="circle-bg" d="M18 2.0845a 15.9155 15.9155 0 0 1 0 31.831a 15.9155 15.9155 0 0 1 0 -31.831" data-astro-cid-6bhvxozq></path> <path id="download-gauge" class="circle" stroke-dasharray="0, 100" d="M18 2.0845a 15.9155 15.9155 0 0 1 0 31.831a 15.9155 15.9155 0 0 1 0 -31.831" data-astro-cid-6bhvxozq></path> <text x="18" y="20.35" class="percentage" id="download" data-astro-cid-6bhvxozq>--</text> </svg> <p data-astro-cid-6bhvxozq>Download <strong data-astro-cid-6bhvxozq>(MB/s)</strong></p> </div> <div class="gauge-item" data-astro-cid-6bhvxozq> <svg viewBox="0 0 36 36" class="circular-chart yellow" data-astro-cid-6bhvxozq> <path class="circle-bg" d="M18 2.0845a 15.9155 15.9155 0 0 1 0 31.831a 15.9155 15.9155 0 0 1 0 -31.831" data-astro-cid-6bhvxozq></path> <path id="upload-gauge" class="circle" stroke-dasharray="0, 100" d="M18 2.0845a 15.9155 15.9155 0 0 1 0 31.831a 15.9155 15.9155 0 0 1 0 -31.831" data-astro-cid-6bhvxozq></path> <text x="18" y="20.35" class="percentage" id="upload" data-astro-cid-6bhvxozq>--</text> </svg> <p data-astro-cid-6bhvxozq>Upload <strong data-astro-cid-6bhvxozq>(MB/s)</strong></p> </div> <div class="gauge-item" data-astro-cid-6bhvxozq> <svg viewBox="0 0 36 36" class="circular-chart red" data-astro-cid-6bhvxozq> <path class="circle-bg" d="M18 2.0845a 15.9155 15.9155 0 0 1 0 31.831a 15.9155 15.9155 0 0 1 0 -31.831" data-astro-cid-6bhvxozq></path> <path id="packet-loss-gauge" class="circle" stroke-dasharray="0, 100" d="M18 2.0845a 15.9155 15.9155 0 0 1 0 31.831a 15.9155 15.9155 0 0 1 0 -31.831" data-astro-cid-6bhvxozq></path> <text x="18" y="20.35" class="percentage" id="packet-loss" data-astro-cid-6bhvxozq>--</text> </svg> <p data-astro-cid-6bhvxozq>Packet Loss (%)</p> </div> </div> <p class="muted" style="margin-top:-.5rem" data-astro-cid-6bhvxozq>
Throughput shown in <strong data-astro-cid-6bhvxozq>MB/s</strong> (megabytes/second). 1&nbsp;MB/s ≈ 8&nbsp;Mbps.
</p> <div class="tool-grid" id="noc-data" data-astro-cid-6bhvxozq></div> <div id="map" data-astro-cid-6bhvxozq></div> <div class="two-col" data-astro-cid-6bhvxozq> <div class="tool-card" data-astro-cid-6bhvxozq> <h3 data-astro-cid-6bhvxozq>First Upstream Hop</h3> <div id="up-body" class="kv" data-astro-cid-6bhvxozq>Resolving…</div> <div id="up-note" class="muted" style="margin-top:.5rem;" data-astro-cid-6bhvxozq></div> </div> <div class="tool-card" data-astro-cid-6bhvxozq> <div class="weather-top" data-astro-cid-6bhvxozq> <h3 data-astro-cid-6bhvxozq>Weather (Current)</h3> <div class="unit-toggle" role="group" aria-label="Temperature units" data-astro-cid-6bhvxozq> <button id="w-c" class="btn btn-small" data-unit="celsius" data-astro-cid-6bhvxozq>°C</button> <button id="w-f" class="btn btn-small" data-unit="fahrenheit" data-astro-cid-6bhvxozq>°F</button> <button id="w-loc" class="btn btn-small" title="Use precise device location" data-astro-cid-6bhvxozq>Use Precise Location</button> </div> </div> <div class="weather-main" data-astro-cid-6bhvxozq> <img id="weather-icon" alt="Weather icon" referrerpolicy="no-referrer" data-astro-cid-6bhvxozq> <div id="weather" class="kv" data-astro-cid-6bhvxozq></div> </div> <div class="tool-card subtle" id="weather-alerts" data-astro-cid-6bhvxozq> <h4 data-astro-cid-6bhvxozq>Severe Weather Alerts</h4> <div id="alerts-body" class="alerts" data-astro-cid-6bhvxozq></div> </div> <p class="muted" style="margin:.5rem 0 0" data-astro-cid-6bhvxozq>Weather data by <a href="https://open-meteo.com/" target="_blank" rel="noopener" data-astro-cid-6bhvxozq>Open-Meteo</a>.</p> </div> </div> <div class="tool-card" id="lan-card" data-astro-cid-6bhvxozq> <h2 data-astro-cid-6bhvxozq>LAN Insights</h2> <p class="muted" data-astro-cid-6bhvxozq>
Local checks use browser-only methods. Best results on <strong data-astro-cid-6bhvxozq>http://localhost</strong>.
          HTTPS may block private network HTTP requests.
</p> <div class="kv" id="lan-webrtc" data-astro-cid-6bhvxozq></div> <div class="lan-actions" data-astro-cid-6bhvxozq> <button id="btn-webrtc" class="btn" data-astro-cid-6bhvxozq>Collect WebRTC LAN Details</button> <button id="btn-gw" class="btn" data-astro-cid-6bhvxozq>Find Gateways</button> <span class="sep" data-astro-cid-6bhvxozq></span> <label class="probe-opts" data-astro-cid-6bhvxozq>
Hosts to scan:
<select id="probe-size" data-astro-cid-6bhvxozq> <option value="32" data-astro-cid-6bhvxozq>32</option> <option value="64" data-astro-cid-6bhvxozq>64</option> <option value="128" data-astro-cid-6bhvxozq>128</option> <option value="254" selected data-astro-cid-6bhvxozq>254 (full /24)</option> </select> </label> <label class="probe-opts" data-astro-cid-6bhvxozq>
Concurrency:
<select id="probe-conc" data-astro-cid-6bhvxozq> <option value="8" data-astro-cid-6bhvxozq>8</option> <option value="16" selected data-astro-cid-6bhvxozq>16</option> <option value="32" data-astro-cid-6bhvxozq>32</option> </select> </label> <button id="btn-scan" class="btn btn-accent" data-astro-cid-6bhvxozq>Run LAN Scan (asks first)</button> <button id="btn-cancel" class="btn btn-danger" disabled data-astro-cid-6bhvxozq>Cancel</button> </div> <div id="lan-warnings" class="muted" data-astro-cid-6bhvxozq></div> <div id="gw-results" data-astro-cid-6bhvxozq></div> <div id="scan-summary" class="summary" data-astro-cid-6bhvxozq></div> <div class="table-wrap" data-astro-cid-6bhvxozq> <table class="scan-table" id="scan-table" data-astro-cid-6bhvxozq> <thead data-astro-cid-6bhvxozq> <tr data-astro-cid-6bhvxozq><th data-astro-cid-6bhvxozq>IP</th><th data-astro-cid-6bhvxozq>Open Ports</th><th data-astro-cid-6bhvxozq>RTT ms</th><th data-astro-cid-6bhvxozq>Tags</th><th data-astro-cid-6bhvxozq>Fav</th></tr> </thead> <tbody data-astro-cid-6bhvxozq></tbody> </table> </div> <div id="scan-progress" class="progress" data-astro-cid-6bhvxozq><div class="bar" data-astro-cid-6bhvxozq></div><span class="label" data-astro-cid-6bhvxozq></span></div> </div> </div> </section> <script type="module">
    // ---------- Helpers ----------
    const log = (...a) => console.debug("[NOC]", ...a);
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));
    const qs = (s) => document.querySelector(s);
    function kv(rows){
      const items = rows
        .filter(([_,v]) => v!==undefined && v!==null && v!=="")
        .map(([k,v]) => "<div><strong>"+k+":</strong> <span>"+v+"</span></div>")
        .join("");
      return '<div class="kv">'+items+"</div>";
    }
    async function tryJSON(url, opts){
      // strict (for things we want errors for)
      const r = await fetch(url, Object.assign({cache:"no-store", credentials:"omit", mode:"cors"}, opts||{}));
      if(!r.ok) throw new Error("HTTP "+r.status);
      return await r.json();
    }
    async function safeJSON(url, opts){
      // never throws; used for APIs that can legitimately return 404/429/etc
      try {
        const r = await fetch(url, Object.assign({cache:"no-store", credentials:"omit", mode:"cors"}, opts||{}));
        if(!r.ok) return null;
        return await r.json();
      } catch { return null; }
    }
    function stddev(a){ const n=a.length; if(n<=1)return 0; const m=a.reduce((x,y)=>x+y,0)/n; const v=a.reduce((x,y)=>(x+(y-m)*(y-m)),0)/(n-1); return Math.sqrt(v); }
    function updateGauge(id, value, max){
      try{
        const g=document.querySelector("#"+id+"-gauge"); if(!g) return;
        const v=Number(value);
        const pct=Number.isFinite(v)?Math.min((v/max)*100,100):0;
        g.setAttribute("stroke-dasharray", pct+", 100");
        const lbl=document.getElementById(id);
        if(lbl) lbl.textContent = Number.isFinite(v)?(v>=10?Math.round(v):v.toFixed(1)):"--";
      }catch{}
    }

    // ---------- Map ----------
    async function ensureLeaflet(){
      if (window.L) return true;
      try {
        await new Promise((res, rej) => {
          const s = document.createElement("script");
          s.src = "https://unpkg.com/leaflet@1.9.4/dist/leaflet.js";
          s.async = true; s.onload = res; s.onerror = rej;
          document.head.appendChild(s);
        });
        return !!window.L;
      } catch { return false; }
    }
    async function initMap(mapId){
      await ensureLeaflet();
      if (!window.L) return null;
      const map = L.map(mapId).setView([20,0], 2);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:18}).addTo(map);
      return map;
    }

    // ---------- Public IP + GEO (quiet, CORS-safe) ----------
    const _geoCache = new Map();
    async function getPublicIPv4(){
      const j = await safeJSON("https://api.ipify.org?format=json");
      return j?.ip || null;
    }
    async function geoLookup(ip){
      if (!ip) return {};
      if (_geoCache.has(ip)) return _geoCache.get(ip);
      let out = {};
      // Primary: ipwho.is (CORS-friendly)
      const j = await safeJSON("https://ipwho.is/"+encodeURIComponent(ip));
      if (j && j.success !== false) {
        out = {
          ip,
          hostname: j.hostname || "",
          asn: j.connection?.asn || "",
          org: j.connection?.org || j.isp || "",
          city: j.city || "",
          region: j.region || j.region_name || "",
          country: j.country || "",
          latitude: j.latitude,
          longitude: j.longitude
        };
      } else {
        // Fallback via proxy to avoid CORS noise
        const k = await safeJSON("https://corsproxy.io/?https://ipapi.co/"+encodeURIComponent(ip)+"/json/");
        if (k) {
          out = {
            ip,
            hostname: k.hostname || "",
            asn: k.asn || "",
            org: k.org || k.org_name || k.company || "",
            city: k.city || "",
            region: k.region || "",
            country: k.country_name || k.country || "",
            latitude: k.latitude,
            longitude: k.longitude
          };
        } else {
          out = { ip };
        }
      }
      _geoCache.set(ip, out);
      return out;
    }

    async function addPublicIPCardAndMarker(map){
      const ip = await getPublicIPv4();
      const geo = await geoLookup(ip || "");
      const card = document.getElementById("noc-data");
      if(card){
        card.insertAdjacentHTML(
          "beforeend",
          '<div class="tool-card"><h3>Public IP & Geo</h3>'+
            kv([
              ["Public IP", geo.ip || "—"],
              ["ASN", geo.asn || "—"],
              ["Org/ISP", geo.org || "—"],
              ["City", geo.city || "—"],
              ["Region", geo.region || "—"],
              ["Country", geo.country || "—"],
              ["Latitude", (geo.latitude!=null?geo.latitude:"—")],
              ["Longitude", (geo.longitude!=null?geo.longitude:"—")]
            ])+
          "</div>"
        );
      }
      if(map && geo.latitude!=null && geo.longitude!=null && window.L){
        L.marker([geo.latitude, geo.longitude]).addTo(map).bindPopup("Public IP Location").openPopup();
        map.setView([geo.latitude, geo.longitude], 6);
      }
      if (geo.latitude!=null && geo.longitude!=null) {
        window._USERLOC = {lat: geo.latitude, lon: geo.longitude};
      }
    }

    // ---------- WAN Gauges (MB/s) ----------
    const PING_URL = "/api/ping";
    const okStatus = (s) => s >= 200 && s < 400;
    const REFRESH_MS = 5000;

    async function rttSamples(n, signal) {
      const arr = [];
      for (let i = 0; i < n; i++) {
        const t0 = performance.now();
        try {
          const r = await fetch(PING_URL+"?t="+Math.random(), { cache: "no-store", signal });
          if (okStatus(r.status)) arr.push(performance.now() - t0);
        } catch {}
      }
      return arr;
    }
    function median(a) {
      if (!a.length) return NaN;
      const b = a.slice().sort((x,y)=>x-y);
      const m = Math.floor(b.length/2);
      return b.length%2 ? b[m] : (b[m-1]+b[m])/2;
    }

    async function streamedDownloadMBps(sizeBytes, signal){
      const url = "https://speed.cloudflare.com/__down?cors=true&bytes="+sizeBytes+"&ts="+Date.now();
      const t0 = performance.now();
      const r = await fetch(url, { cache:"no-store", signal });
      if (!r.body) throw new Error("No readable body");
      const reader = r.body.getReader();
      let received = 0;
      while (true) {
        const { value, done } = await reader.read();
        if (done) break;
        if (value) received += value.length;
      }
      const s = (performance.now() - t0) / 1000;
      if (!isFinite(s) || s <= 0) return NaN;
      return (received/1e6) / s;
    }
    async function opaqueDownloadMBps(sizeBytes, signal){
      const url = "https://speed.cloudflare.com/__down?bytes="+sizeBytes+"&nocache="+Date.now();
      const t0 = performance.now();
      await fetch(url, { cache:"no-store", mode:"no-cors", signal });
      const s = (performance.now() - t0) / 1000;
      if (!isFinite(s) || s <= 0) return NaN;
      return (sizeBytes/1e6) / s;
    }
    async function downloadMBps(signal){
      const sizeBytes = 12 * 1024 * 1024;
      try {
        const a = await streamedDownloadMBps(sizeBytes, signal);
        const b = await streamedDownloadMBps(sizeBytes, signal);
        if (isFinite(a) && isFinite(b)) return (a + b) / 2;
        if (isFinite(a)) return a;
        if (isFinite(b)) return b;
      } catch(e) {
        try{
          const a = await opaqueDownloadMBps(sizeBytes, signal);
          const b = await opaqueDownloadMBps(sizeBytes, signal);
          if (isFinite(a) && isFinite(b)) return (a + b) / 2;
          if (isFinite(a)) return a;
          if (isFinite(b)) return b;
        } catch {}
      }
      return NaN;
    }
    async function postSizedMBps(url, sizeBytes, signal){
      const data = new Uint8Array(sizeBytes);
      const t0 = performance.now();
      await fetch(url, { method:"POST", body:data, mode:"no-cors", cache:"no-store", signal });
      const s = (performance.now() - t0) / 1000;
      if (!isFinite(s) || s <= 0) return NaN;
      return (sizeBytes/1e6) / s;
    }
    async function uploadMBps(signal){
      const sizeBytes = 3 * 1024 * 1024;
      const endpoints = [
        "https://speed.cloudflare.com/__up?nocache="+Date.now(),
        "https://httpbin.org/post",
        "https://postman-echo.com/post"
      ];
      for (const u of endpoints){
        try{
          const v = await postSizedMBps(u, sizeBytes, signal);
          if (isFinite(v)) return v;
        }catch{}
      }
      return NaN;
    }
    async function runWANProbesCycle(signal){
      const N = 20;
      const samples = await rttSamples(N, signal);
      if (samples.length) {
        const med = median(samples);
        const jit = stddev(samples);
        const lossPct = 100 * (1 - samples.length / N);
        updateGauge("latency", med, 500);
        updateGauge("jitter",  jit, 200);
        updateGauge("packet-loss", lossPct, 100);
      } else {
        updateGauge("latency", 0, 500);
        updateGauge("jitter",  0, 200);
        updateGauge("packet-loss", 100, 100);
      }
      try { updateGauge("download", await downloadMBps(signal), 125); } catch {}
      try { updateGauge("upload", await uploadMBps(signal), 50); } catch {}
    }
    async function runWANProbes(){
      let timer = null;
      let inFlight = null;
      async function cycle(){
        if (inFlight) inFlight.abort();
        inFlight = new AbortController();
        const signal = inFlight.signal;
        await runWANProbesCycle(signal);
      }
      function start(){ if (timer) return; cycle(); timer = setInterval(()=>{ if(!document.hidden) cycle(); }, 5000); }
      function stop(){ if (timer){ clearInterval(timer); timer=null; } if (inFlight){ inFlight.abort(); inFlight=null; } }
      document.addEventListener("visibilitychange", ()=> document.hidden ? stop() : start());
      start();
    }

    // ---------- Provider edge ----------
    const PRIVATE_RE = /^(10\.|192\.168\.|172\.(1[6-9]|2\d|3[0-1])\.)/;
    const CGN_RE     = /^100\.(6[4-9]|[7-9]\d|1[0-1]\d|12[0-7])\./;
    const isPrivate  = (ip) => PRIVATE_RE.test(ip||"");
    const isCGN      = (ip) => CGN_RE.test(ip||"");
    const isNonInternet = (ip) => isPrivate(ip) || isCGN(ip);
    function bestRttFromHop(h){
      if (typeof h?.rtt === "number") return Math.round(h.rtt);
      if (Array.isArray(h?.rtts) && h.rtts.length) return Math.round(Math.min(...h.rtts));
      return null;
    }
    async function fetchTraceJSON(){
      const urls = [
        "/api/trace.json?target=1.1.1.1",
        "https://api.iptrace.dev/api/trace/1.1.1.1",
        "https://corsproxy.io/?https://api.iptrace.dev/api/trace/1.1.1.1"
      ];
      for (const u of urls){
        try{
          const r = await fetch(u, { cache:"no-store" });
          const j = await r.json();
          if (j && Array.isArray(j.hops)) return j;
        }catch{}
      }
      throw new Error("All trace endpoints blocked or unavailable.");
    }
    function normalizeHops(hopsRaw){
      const hops = [];
      for (const h of (hopsRaw||[])) {
        const ip = h?.ip || h?.address || h?.ipAddress;
        if (!ip) continue;
        const rtt = bestRttFromHop(h);
        if (hops.length===0 || hops[hops.length-1].ip !== ip) hops.push({ ip, rtt });
      }
      return hops;
    }
    function pickProviderEdge(hops, myV4, destination="1.1.1.1"){
      let startIdx = 0;
      if (myV4) {
        const idx = hops.findIndex(h => h.ip === myV4);
        if (idx >= 0) startIdx = idx + 1;
      }
      if (startIdx === 0) {
        const gwIdx = hops.findIndex(h => isNonInternet(h.ip));
        if (gwIdx >= 0) startIdx = gwIdx + 1;
      }
      for (let i=startIdx; i<hops.length; i++){
        const ip = hops[i].ip;
        if (!ip) continue;
        if (isNonInternet(ip)) continue;
        if (ip === destination) continue;
        return hops[i];
      }
      return null;
    }
    function haversine(a,b){
      const R=6371, t=x=>x*Math.PI/180;
      const dLat=t(b.lat-a.lat), dLon=t(b.lon-a.lon);
      const s1=Math.sin(dLat/2)**2 + Math.cos(t(a.lat))*Math.cos(t(b.lat))*Math.sin(dLon/2)**2;
      const c=2*Math.atan2(Math.sqrt(s1),Math.sqrt(1-s1));
      const km=R*c, mi=km*0.621371;
      return {km:Math.round(km*10)/10, mi:Math.round(mi*10)/10};
    }
    let _hopMarker=null, _hopLine=null;
    async function updateUpstreamCard(map){
      const body = qs("#up-body"), note = qs("#up-note");
      if (!body) return;
      try{
        body.textContent = "Resolving…";
        const myV4 = await getPublicIPv4();
        const trace   = await fetchTraceJSON();
        const hops    = normalizeHops(trace.hops);
        const edgeHop = pickProviderEdge(hops, myV4, "1.1.1.1");

        if(!edgeHop){
          body.innerHTML = '<div class="muted">Failed to resolve provider edge (no public hop before destination).</div>';
          if (note) note.textContent = "Auto-refresh every 60s.";
          return;
        }

        const ip = edgeHop.ip;
        const rtt = edgeHop.rtt;
        const geo = await geoLookup(ip);
        const hostname = geo.hostname || "n/a";
        const city=geo.city||"", region=geo.region||"", country=(geo.country||"");
        const lat = (typeof geo.latitude === "number") ? geo.latitude : null;
        const lon = (typeof geo.longitude === "number") ? geo.longitude : null;

        let distance = "n/a";
        if (window._USERLOC && lat!=null && lon!=null) {
          const d = haversine(window._USERLOC, {lat, lon});
          distance = d.km+" km ("+d.mi+" mi)";
        }

        body.innerHTML = kv([
          ["IP", ip],
          ["Hostname", hostname],
          ["Latency (RTT)", (rtt!=null ? (rtt+" ms") : "n/a")],
          ["Location", ([city, region, country].filter(Boolean).join(", ")) || "—"],
          ["Latitude", (lat!=null?lat:"—")],
          ["Longitude", (lon!=null?lon:"—")],
          ["Distance from you", distance]
        ]);
        if (note) note.textContent = "Auto-refresh every 60s.";

        try{
          if(map && window.L && lat!=null && lon!=null){
            if (_hopMarker) { map.removeLayer(_hopMarker); _hopMarker=null; }
            if (_hopLine)   { map.removeLayer(_hopLine);   _hopLine=null; }
            _hopMarker = L.marker([lat, lon]).addTo(map).bindPopup("Provider Edge: "+ip+(hostname && hostname!=="n/a" ? "<br>"+hostname : ""));
            if (window._USERLOC?.lat != null && window._USERLOC?.lon != null) {
              _hopLine = L.polyline([[window._USERLOC.lat, window._USERLOC.lon],[lat,lon]], {color:"#4ea3ff"}).addTo(map);
              map.fitBounds(_hopLine.getBounds(), {padding:[30,30]});
            } else {
              map.setView([lat, lon], 7);
            }
          }
        }catch(e){}
      }catch(e){
        body.innerHTML = '<div class="muted">Failed to resolve provider edge.</div>';
        if (note) note.textContent = "Auto-refresh every 60s.";
      }
    }

    // ---------- Weather ----------
    let weatherUnit=localStorage.getItem("weatherUnit")||"fahrenheit";
    let weatherLoc=null;
    function setUnitButtons(){ const c=qs("#w-c"), f=qs("#w-f"); if(!c||!f) return; c.classList.toggle("active",weatherUnit==="celsius"); f.classList.toggle("active",weatherUnit==="fahrenheit"); }
    function wmoToIconName(code,isDay){
      if(code===0)return isDay?"clear-day":"clear-night";
      if(code===1||code===2)return isDay?"partly-cloudy-day":"partly-cloudy-night";
      if(code===3)return"overcast";
      if(code===45||code===48)return"fog";
      if(code===51||code===53||code===55)return"drizzle";
      if(code===56||code===57)return"freezing-drizzle";
      if(code===61||code===63||code===65)return"rain";
      if(code===66||code===67)return"freezing-rain";
      if(code===71||code===73||code===75||code===77)return"snow";
      if(code===80||code===81||code===82)return"rain-showers";
      if(code===85||code===86)return"snow-showers";
      if(code===95)return"thunderstorm";
      if(code===96||code===99)return"thunderstorm-hail";
      return isDay?"partly-cloudy-day":"partly-cloudy-night";
    }
    function setWeatherIcon(code,isDay){
      const img=qs("#weather-icon"); if(!img) return;
      const name=wmoToIconName(code,!!isDay);
      img.style.display="";
      // quiet image load; if blocked/aborted we hide it without error
      img.onload = function(){};
      img.onerror=function(){
        img.style.display="none";
        const old=document.querySelector(".emoji-fallback"); if(old) old.remove();
        const f=document.createElement("div"); f.className="emoji-fallback"; f.textContent=isDay?"☀️":"🌙"; img.after(f);
      };
      img.src="https://open-meteo.com/images/weather-icons/"+name+".png";
      img.alt=name.replace(/-/g," ");
    }
    function nearestHourIndex(times){
      const now=Date.now(); let best=0,bestDiff=Infinity;
      for(let i=0;i<times.length;i++){ const t=new Date(times[i]).getTime(); const d=Math.abs(t-now); if(d<bestDiff){best=i;bestDiff=d;} }
      return best;
    }
    async function renderWeather(lat,lon){
      const unitParam=weatherUnit==="fahrenheit"?"fahrenheit":"celsius";
      const windUnit=weatherUnit==="fahrenheit"?"mph":"ms";
      const base="latitude="+encodeURIComponent(lat)+"&longitude="+encodeURIComponent(lon)+"&timezone=auto";
      const current="temperature_2m,relative_humidity_2m,apparent_temperature,precipitation,cloud_cover,wind_speed_10m,wind_direction_10m,weather_code,is_day";
      const hourly="precipitation_probability,precipitation";
      const url="https://api.open-meteo.com/v1/forecast?"+base+"&current="+current+"&hourly="+hourly+"&temperature_unit="+unitParam+"&wind_speed_unit="+windUnit+"&forecast_days=2";
      const w=await safeJSON(url);
      if(!w){ qs("#weather").textContent="Weather API failed."; const icon=qs("#weather-icon"); if(icon) icon.style.display="none"; return; }
      const c=w.current||{}; setWeatherIcon((c.weather_code!=null?c.weather_code:0),c.is_day);
      let nowP="n/a", max6="n/a";
      try{
        const H=w.hourly||{}; const times=H.time||[]; const probs=H.precipitation_probability||[];
        if(times.length&&probs.length){
          const idx=nearestHourIndex(times);
          const slice=probs.slice(idx,Math.min(idx+6,probs.length)).filter(v=>typeof v==="number");
          if(typeof probs[idx]==="number") nowP=probs[idx]+" %";
          if(slice.length) max6=Math.max.apply(null, slice)+" %";
        }
      }catch{}
      const tU=weatherUnit==="fahrenheit"?"°F":"°C", wU=weatherUnit==="fahrenheit"?"mph":"m/s";
      qs("#weather").innerHTML=kv([
        ["Temp", (c.temperature_2m!==undefined?(c.temperature_2m+" "+tU):"n/a")],
        ["Feels Like", (c.apparent_temperature!==undefined?(c.apparent_temperature+" "+tU):"n/a")],
        ["Chance of Rain (now)", nowP],
        ["Chance of Rain (≤6h max)", max6],
        ["Precip (current)", (c.precipitation!==undefined?(c.precipitation+" mm"):"n/a")],
        ["Humidity", (c.relative_humidity_2m!==undefined?(c.relative_humidity_2m+" %"):"n/a")],
        ["Cloud Cover", (c.cloud_cover!==undefined?(c.cloud_cover+" %"):"n/a")],
        ["Wind", (c.wind_speed_10m!==undefined?(c.wind_speed_10m+" "+wU):"n/a")],
        ["Wind Dir", (c.wind_direction_10m!==undefined?(c.wind_direction_10m+"°"):"n/a")],
        ["Daytime", c.is_day?"Yes":"No"]
      ]);
    }
    async function renderAlerts(lat,lon){
      const el=qs("#alerts-body"); el.textContent="Checking alerts…";
      // Try Open-Meteo warnings quietly (no console errors on 404/429)
      const om = await safeJSON("https://api.open-meteo.com/v1/warnings?latitude="+encodeURIComponent(lat)+"&longitude="+encodeURIComponent(lon)+"&timezone=auto");
      if (om && Array.isArray(om.alerts||om.warnings) && (om.alerts||om.warnings).length){
        const alerts=(om.alerts||om.warnings).slice(0,5);
        el.innerHTML = alerts.map(function(a){
          const t=a.event||a.headline||"Alert";
          const sev=a.severity||"";
          const eff=a.effective||a.onset||a.start||"";
          const exp=a.expires||a.end||"";
          const src=a.sender||a.sender_name||a.source||"";
          const body=((a.description||a.instruction||"")+"").slice(0,200);
          return '<div class="alert">'+
            '<div class="alert-title">'+t+(sev?(' · <span class="sev">'+sev+'</span>'):"")+'</div>'+
            '<div class="alert-meta">'+(eff?('Start: '+eff):"")+(exp?(' · End: '+exp):"")+(src?(' · '+src):"")+'</div>'+
            (body?('<div class="alert-desc">'+body+((a.description&&a.description.length>200)?"…":"")+'</div>'):"")+
          '</div>';
        }).join("");
        return;
      }
      // Fallback: US NWS (quiet)
      const nws=await safeJSON("https://api.weather.gov/alerts/active?point="+lat+","+lon);
      const feats=Array.isArray(nws?.features)?nws.features:[];
      if (feats.length){
        el.innerHTML = feats.slice(0,5).map(function(f){
          const p=f.properties||{};
          const ttl=p.headline||p.event||"Alert";
          const sev=p.severity||"";
          const eff=p.effective||"";
          const exp=p.expires||"";
          const desc=(p.description||"").slice(0,220);
          const url=p.id||p["@id"]||p.uri||"";
          return '<div class="alert">'+
            '<div class="alert-title">'+ttl+(sev?(' · <span class="sev">'+sev+'</span>'):"")+'</div>'+
            '<div class="alert-meta">'+(eff?('Start: '+eff):"")+(exp?(' · End: '+exp):"")+'</div>'+
            (desc?('<div class="alert-desc">'+desc+((p.description&&p.description.length>220)?"…":"")+'</div>'):"")+
            (url?('<div class="alert-link"><a href="'+url+'" target="_blank" rel="noopener">Details</a></div>'):"")+
          '</div>';
        }).join("");
        return;
      }
      el.innerHTML='<div class="muted">No active alerts or alert service unavailable.</div>';
    }

    // ---------- LAN scanner (unchanged functional) ----------
    async function getWebRTCDetails(ms){
      ms = ms || 3000;
      const info={hostIPs:new Set(), srflxIPs:new Set(), relay:false, mdns:new Set(), raw:[]};
      try{
        const pc=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});
        pc.createDataChannel("probe");
        pc.onicecandidate=function(ev){
          try{
            if(!ev||!ev.candidate) return;
            const c=ev.candidate.candidate||"";
            info.raw.push(c);
            const m=c.match(/(\d{1,3}(?:\.\d{1,3}){3})/);
            const addr=m?m[1]:null;
            if(addr && /^(10\.|192\.168\.|172\.(1[6-9]|2\d|3[0-1])\.)/.test(addr)) info.hostIPs.add(addr);
            if(c.indexOf("typ srflx")>-1 && addr) info.srflxIPs.add(addr);
            if(c.indexOf("typ relay")>-1) info.relay=true;
            if(c.indexOf(".local")>-1) info.mdns.add(c);
          }catch{}
        };
        await pc.setLocalDescription(await pc.createOffer());
        await Promise.race([new Promise(function(r){pc.onicegatheringstatechange=function(){if(pc.iceGatheringState==="complete") r();};}), sleep(ms)]);
        pc.close();
      }catch{}
      return {hostIPs:[...info.hostIPs], srflxIPs:[...info.srflxIPs], relayUsed:info.relay, mdnsCandidates:[...info.mdns].slice(0,3), rawCount:info.raw.length};
    }
    async function opaquePing(url,ms){
      ms = ms || 1500;
      const ac=new AbortController(); const t=setTimeout(function(){ac.abort();},ms);
      const t0=performance.now();
      try{ await fetch(url,{mode:"no-cors",cache:"no-store",signal:ac.signal}); return Number((performance.now()-t0).toFixed(1)); }
      catch{return null;}
      finally{ clearTimeout(t); }
    }
    function ipToSubnet24(ip){ const p=ip.split("."); if(p.length!==4) return null; return p[0]+"."+p[1]+"."+p[2]+"."; }
    function deriveGatewayCandidates(ip){
      const p=ip.split("."); if(p.length!==4) return ["192.168.1.1","192.168.0.1","10.0.0.1","172.16.0.1"];
      const base=p[0]+"."+p[1]+"."+p[2]+".";
      return Array.from(new Set([base+"1",base+"254",base+"2",p[0]+"."+p[1]+".0.1",p[0]+".0.0.1"]));
    }
    function tagHost(open){
      const t=[]; if(open.indexOf(80)>-1||open.indexOf(443)>-1||open.indexOf(8443)>-1) t.push("Web Admin?");
      if(open.indexOf(32400)>-1) t.push("Media/Plex");
      if(open.indexOf(8123)>-1) t.push("Home Assistant");
      if(open.indexOf(8080)>-1) t.push("Alt UI");
      if(open.indexOf(8888)>-1) t.push("Dev/UI");
      return t.length?t.join(", "):"—";
    }
    function makeFaviconCell(ip){
      const img=new Image(); img.loading="lazy"; img.referrerPolicy="no-referrer"; img.width=16; img.height=16; img.src="http://"+ip+"/favicon.ico";
      const span=document.createElement("span"); span.className="favwrap";
      img.onerror=function(){span.textContent="—";};
      img.onload=function(){span.appendChild(img);};
      setTimeout(function(){ if(!img.complete) span.textContent="—"; },2500);
      return span;
    }
    async function runScanner(){
      const btnScan=qs("#btn-scan"), btnCancel=qs("#btn-cancel"), tableBody=document.querySelector("#scan-table tbody"), summaryEl=qs("#scan-summary"), prog=qs("#scan-progress"), progBar=prog?prog.querySelector(".bar"):null, progLabel=prog?prog.querySelector(".label"):null, sizeSel=qs("#probe-size"), concSel=qs("#probe-conc");
      if(!btnScan||!btnCancel||!tableBody||!summaryEl) return;
      let cancel=false; btnCancel.addEventListener("click",function(){cancel=true;});
      btnScan.addEventListener("click", async function(){
        const consent=confirm("Run a rich LAN scan?\n- Tests ports: 80,443,8080,8443,8888,5000,32400,8123\n- Displays favicons when available\n- Results stay in your browser");
        if(!consent) return;
        btnScan.disabled=true; btnCancel.disabled=false; cancel=false; tableBody.innerHTML=""; summaryEl.textContent=""; if(progBar) progBar.style.width="0%"; if(progLabel) progLabel.textContent="";
        const details=await getWebRTCDetails(2000); const baseIP=(details.hostIPs[0]||"192.168.1.100"); const subnet=ipToSubnet24(baseIP); const total=parseInt((sizeSel?sizeSel.value:"254"),10)||254; const conc=parseInt((concSel?concSel.value:"16"),10)||16; const ports=[80,443,8080,8443,8888,5000,32400,8123];
        const hosts=[]; for(let i=1;i<=Math.min(254,total);i++) hosts.push(subnet+i);
        let done=0,found=0; const update=function(){done++; if(progBar&&progLabel){const pct=Math.min(100,Math.round((done/hosts.length)*100)); progBar.style.width=pct+"%"; progLabel.textContent=done+"/"+hosts.length;}};
        const sem=[]; const push=function(fn){ const p=fn().then(function(){sem.splice(sem.indexOf(p),1);}).catch(function(){sem.splice(sem.indexOf(p),1);}); sem.push(p); if(sem.length>=conc) return Promise.race(sem); return Promise.resolve(); };
        const start=performance.now();
        for(const ip of hosts){
          if(cancel) break;
          await push(async function(){
            const rtts={};
            for(const port of ports){ const proto=(port===443||port===8443)?"https":"http"; rtts[port]=await opaquePing(proto+"://"+ip+":"+port+"/",1100); }
            const open=ports.filter(function(p){ return rtts[p]!==null; });
            if(open.length){
              found++;
              const tr=document.createElement("tr");
              const tdIP=document.createElement("td"); tdIP.textContent=ip;
              const tdPorts=document.createElement("td"); tdPorts.textContent=open.slice().sort(function(a,b){return a-b;}).join(", ");
              const tdRTT=document.createElement("td"); tdRTT.textContent=open.map(function(p){return p+":"+rtts[p]+"ms";}).join("  ");
              const tdTags=document.createElement("td"); tdTags.textContent=tagHost(open);
              const tdFav=document.createElement("td"); tdFav.appendChild(makeFaviconCell(ip));
              tr.append(tdIP,tdPorts,tdRTT,tdTags,tdFav); tableBody.appendChild(tr);
            }
            update();
          });
        }
        await Promise.allSettled(sem);
        const dur=((performance.now()-start)/1000).toFixed(1);
        summaryEl.innerHTML='Found <strong>'+found+'</strong> responsive host(s) out of '+hosts.length+' in '+dur+'s.'+(cancel?' <span class="muted">(scan cancelled)</span>':'');
        btnScan.disabled=false; btnCancel.disabled=true;
      });
    }

    // ---------- Bootstrap ----------
    window.addEventListener("load", async function(){
      const map = await initMap("map");
      await addPublicIPCardAndMarker(map);
      await runWANProbes();

      await updateUpstreamCard(map);
      setInterval(function(){ updateUpstreamCard(map); }, 60000);

      if (location.protocol === "https:") {
        const w=qs("#lan-warnings");
        if (w) w.textContent = "⚠️ HTTPS page: browsers often block HTTP to private IPs. Run from http://localhost for fullest LAN results.";
      }

      if (window._USERLOC) { weatherLoc = {lat:window._USERLOC.lat, lon:window._USERLOC.lon}; }
      const setUnit=async function(unit){ weatherUnit=unit; localStorage.setItem("weatherUnit",unit); setUnitButtons(); if(weatherLoc) await renderWeather(weatherLoc.lat,weatherLoc.lon); };
      setUnitButtons();
      const btnC=qs("#w-c"), btnF=qs("#w-f"), btnLoc=qs("#w-loc");
      if(btnC) btnC.addEventListener("click",function(){ setUnit("celsius"); });
      if(btnF) btnF.addEventListener("click",function(){ setUnit("fahrenheit"); });
      if(btnLoc) btnLoc.addEventListener("click",function(){
        if(!("geolocation" in navigator)) return;
        navigator.geolocation.getCurrentPosition(async function(pos){
          weatherLoc={lat:pos.coords.latitude,lon:pos.coords.longitude};
          window._USERLOC={lat:weatherLoc.lat, lon:weatherLoc.lon};
          await renderWeather(weatherLoc.lat,weatherLoc.lon);
          await renderAlerts(weatherLoc.lat,weatherLoc.lon);
        });
      });
      if(weatherLoc){ await renderWeather(weatherLoc.lat,weatherLoc.lon); await renderAlerts(weatherLoc.lat,weatherLoc.lon); }

      const btnWebRTC=qs("#btn-webrtc");
      if(btnWebRTC) btnWebRTC.addEventListener("click", async function(){
        const d=await getWebRTCDetails(3000);
        qs("#lan-webrtc").innerHTML=kv([
          ["Host (private) IPs", d.hostIPs.length?d.hostIPs.join(", ") :"none"],
          ["STUN reflexive (public) IPs", d.srflxIPs.length?d.srflxIPs.join(", ") :"none"],
          ["Relay Used", d.relayUsed?"Yes":"No"],
          ["mDNS candidates", d.mdnsCandidates.length?d.mdnsCandidates.join(" | "):"—"],
          ["ICE candidates seen", d.rawCount]
        ]);
      });

      const btnGw=qs("#btn-gw");
      if(btnGw) btnGw.addEventListener("click", async function(){
        const det=await getWebRTCDetails(1500);
        const base=(det.hostIPs[0]||"192.168.1.100");
        const cands=deriveGatewayCandidates(base);
        const rows=[];
        for(const ip of cands){ const rtt=await opaquePing("http://"+ip+"/",1400); rows.push([ip, rtt===null?"unreachable/blocked":(rtt+" ms")]); }
        const fastest = rows
          .map(function(x){ return [x[0], parseFloat((x[1]||"").replace(" ms",""))]; })
          .filter(function(x){ return !isNaN(x[1]); })
          .sort(function(a,b){ return a[1]-b[1]; })[0];
        qs("#gw-results").innerHTML='<h3>Gateway Candidates (opaque RTT)</h3>'+kv(rows)+(fastest?('<p class="muted">Fastest: <strong>'+fastest[0]+'</strong> (~'+fastest[1]+' ms)</p>'):"");
      });

      await runScanner();
    });
  </script>   </main> <footer class="mt-auto flex w-full flex-col items-center justify-center gap-y-2 pt-10 pb-4 text-center align-top font-semibold text-gray-600 sm:flex-row sm:justify-between sm:text-xs dark:text-gray-400"> <div class="me-0 sm:me-4">
&copy; J The Admin 2025.<span class="inline-block">&nbsp;🚀&nbsp;Ping.Trace.SSH</span> </div> <!-- Hidden on mobile, shown from md and up --> <nav aria-labelledby="footer_links" class="hidden md:flex gap-x-2 md:gap-x-0 md:divide-x md:divide-gray-500"> <p id="footer_links" class="sr-only">More on this site</p> <a class="hover:text-global-text px-4 py-2 hover:underline md:py-0" href="/"> Home </a><a class="hover:text-global-text px-4 py-2 hover:underline md:py-0" href="/services/"> Services </a><a class="hover:text-global-text px-4 py-2 hover:underline md:py-0" href="/career/"> Career Tools </a><a class="hover:text-global-text px-4 py-2 hover:underline md:py-0" href="/free-tools/"> Networking Tools </a><a class="hover:text-global-text px-4 py-2 hover:underline md:py-0" href="/breakroom/"> Breakroom </a><a class="hover:text-global-text px-4 py-2 hover:underline md:py-0" href="/about/"> About </a> </nav> </footer> <!-- Hide footer navigation links on mobile only -->  </body> </html>